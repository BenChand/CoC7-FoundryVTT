<div class="coc7 chat-card chat-card-v2">
  <form class="flexcol">
    <header class="card-header">
      <div class="left-portrait">
        {{#if displayActorOnCard}}
					<img class="open-actor {{card.participant.cssClass}}" data-actor-key="{{card.participant.key}}" src="{{card.participant.icon}}" title="{{card.participant.name}}" width="36" height="36"/>
        {{/if}}
      </div>
      {{#if data.states.obstacleDefined}}
      <div class="card-title">{{#if data.obstacle.name}}{{data.obstacle.name}}{{else}}{{ localize 'CoC7.Obstacle'}}{{/if}}</div>
      <div class="right-portrait">
          {{#if data.obstacle.barrier}}
            <img src="systems/CoC7/assets/icons/barrier.svg">
          {{else}}
            <img src="systems/CoC7/assets/icons/hazard-sign.svg">
          {{/if}}
      </div>
      {{/if}}
    </header>

		<datalist id="check-options">
      
      {{#each checkOptions as |o|}}
        <option>{{o}}</option>
      {{/each}}
    </datalist>

    <div class="player-actions">
      <div class='info'>
        {{#if data.states.obstacleDefined}}
          <div>{{strings.obstacleDefined}}</div>
          {{#if data.states.playerActionDefined}}
            <div>**** playerIntentions {{ strings.playerIntentions }} ****</div>
            {{#unless dummyActor}}
              {{#if data.states.checkRolled}}
                <div class="roll-line">**** checkRolled {{ strings.checkRolled}} **** {{data.card.roll.value.value.name}} : {{{ htmlCheck }}}</div>
                {{#if data.objects.check.passed}}
                  <div>**** obstaclePassed {{ strings.obstaclePassed }} ****</div>
                {{else}}
                  <div>**** checkFailed {{ strings.checkFailed }} ****</div>
                  {{#if data.states.cardResolved}}
                    {{#if damageTaken}}
                      <div class="roll-line">**** damageTaken {{ strings.damageTaken}} **** : {{{inlineDamageTakenRoll}}}</div>
                    {{/if}}
                    {{#if actionLost}}
                      <div class="roll-line">**** actionLost {{ strings.actionLost }} **** : {{{inlineActionLostRoll}}}</div>
                    {{/if}}
                  {{/if}}
                {{/if}}
              {{else}}
                {{#if data.states.tryToBreak}}
                  <div> {{ localize 'CoC7.PlayerTryToBreakObstacle' }}</div>
                  <div class="card-buttons">
                    <button class='submit' data-ecc-visibility="{{card.participant.actor.uuid}}" data-action='rollObstacleDamage'>{{ card.strings.damageRollRequest }}</button>
                  </div>
                {{else}}
                  <div class="card-buttons">
                    <button class='submit' data-ecc-visibility="{{card.participant.actor.uuid}}" data-action='rollSkillCheck'>{{ strings.checkRollRequest }}</button>
                  </div>
                {{/if}}
              {{/if}}
            {{/unless}}
          {{else}}
            <div>{{ localize 'CoC7.AskIntentions' }}</div>
          {{/if}}
        {{else}}
          <div>{{ localize 'CoC7.SomethingInTheWay' }}</div>
        {{/if}}
      </div>
    </div>

    <div data-ecc-visibility="gm" class="gm-actions">
      {{#if data.states.obstacleDefined}}
        {{#if data.states.breakOrPassDefined}}
          {{#if data.states.tryToNegotiate}}
            {{#if data.states.playerActionDefined}}
              {{#if data.states.checkRolled}}
                {{#if data.objects.check.passed}}
                  Check passed
                {{else}}
                  Check failed
                  {{#if data.states.cardResolved}}
                  {{else}}
                    {{#if data.obstacle.barrier}}
                      Barier failed
                      <div class="form-group small">
                        <div class="flexrow flex1">
                        </div>
                        <div class="flexrow flex1">
                          <a data-ecc-permissions="gm" data-name="data.obstacle.hasDamage" class="icon ecc-switch">
                            <i class="game-icon game-icon-broken-bone"></i>
                          </a>
                          {{#if data.obstacle.hasDamage }}
                            <input type="text" data-ecc-permissions="gm" name="data.obstacle.failedCheckDamage" value="{{data.obstacle.failedCheckDamage}}">
                          {{/if}}
                        </div>
                      </div>
                      <div class="card-buttons">
                        {{#if cardvalidFailedRolls}}
                        <button class="submit" data-action="rollFailConsequences">Validate</button>
                        {{/if}}
                      </div>
                    {{/if}}
                    {{#if data.obstacle.hazard}}
                      Hazard failed
                      {{#if data.states.failedConsequencesRolled}}
                        {{#if data.obstacle.hasDamage}}
                          {{#if data.states.failedCheckDamageApplied}}
                          {{else}}
                            <div class="form-group armor">
                              <div class="flexrow flex-end">
                                <a data-ecc-permissions="gm" data-flag="ignoreArmor" class="ecc-switch" title="{{ localize 'CoC7.IgnoreArmor' }}">
                                  {{#if data.flags.ignoreArmor}}
                                    <i class="game-icon game-icon-armor-downgrade"></i>
                                  {{else}}
                                    <i class="game-icon game-icon-armor-upgrade"></i>
                                  {{/if}}
                                </a>
                                {{#unless data.flags.ignoreArmor}}
                                  <label>{{ localize 'CoC7.Armor'}}:</label>
                                  <input type="text" data-ecc-permissions="gm" name="data.card.armor" value="{{data.card.armor}}">
                                {{/unless}}

                              </div>
                            </div>
                          {{/if}}
                        {{/if}}
                      {{else}}
                        <div class="form-group small">
                          <div class="flexrow flex1">
                            <a data-ecc-permissions="gm" data-name="data.obstacle.hasActionCost" class="icon ecc-switch">
                              <i class="fas fa-bahai"></i>
                            </a>
                            {{#if data.obstacle.hasActionCost }}
                              <input type="text" data-ecc-permissions="gm" name="data.obstacle.failedActionCost" value="{{data.obstacle.failedActionCost}}">
                            {{/if}}
                          </div>
                          <div class="flexrow flex1">
                            <a data-ecc-permissions="gm" data-name="data.obstacle.hasDamage" class="icon ecc-switch">
                              <i class="game-icon game-icon-broken-bone"></i>
                            </a>
                            {{#if data.obstacle.hasDamage }}
                              <input type="text" data-ecc-permissions="gm" name="data.obstacle.failedCheckDamage" value="{{data.obstacle.failedCheckDamage}}">
                            {{/if}}
                          </div>
                        </div>
                        <div class="card-buttons">
                          {{#if card.validFailedRolls}}
                          <button class="submit" data-action="rollFailConsequences">Validate</button>
                          {{/if}}
                        </div>
                      {{/if}}
                    {{/if}}
                  {{/if}}
                {{/if}}
              {{else}}
                <span>{{ localize 'CoC7.WaitForPlayerInput' }}</span>
              {{/if}}
            {{else}}
              <div class="form-group small">
                {{#if card.participant.hasBonusDice}}
                <a data-ecc-permissions="gm" data-flag="consumeBonusDice" class="icon bigger ecc-switch" title="{{ localize 'CoC7.ConsumeBonusDice' }}"><i class="game-icon game-icon-dice-fire"></i></a>
                {{/if}}
                <input type="range" data-ecc-permissions="gm" name="data.card.bonusDice" min="-2" max="2" value="{{data.card.bonusDice}}" class="slider">
                {{#if data.obstacle.barrier}}
                  <button class="submit button-icon" data-action="cancelBreakOrPassChoice" title="{{ localize 'CoC7.Cancel' }}"><i class="fas fa-undo"></i></button>
                {{else}}
                  <button class="submit button-icon" data-action="cancelObstacleDefinition" title="{{ localize 'CoC7.Cancel' }}"><i class="fas fa-undo"></i></button>
                {{/if}}
              </div>
              <div class="form-group">
                <input type="text" class="flex4" data-ecc-permissions="gm" name="data.obstacle.checkName" value="{{data.obstacle.checkName}}"
                  list='check-options' placeholder="{{ localize 'CoC7.Skill' }}"/>
                {{#if validSkill}}
                  : {{skill.value.value}}%
                {{else}}
                  : <input type="text" data-ecc-permissions="gm" name="data.card.checkThreshold" value="{{data.card.checkThreshold}}"
                    placeholder="{{ localize 'CoC7.Value'}}" title="{{strings.EnterValueTitle}}"/>
                {{/if}}
              </div>
              <div class="card-buttons">
                {{#if validCheck}}
                <button class="submit" data-action="requestRoll">Request roll</button>
                {{/if}}
              </div>
            {{/if}}
          {{/if}}
          {{#if data.states.tryToBreak}}
            {{#if data.states.playerActionDefined}}
            {{else}}
              <div class="form-group small">
                <span class="icon bigger" title="{{ localize 'CoC7.HitPoints' }}"><i class="game-icon game-icon-life-bar"></i></span>
                <input type="text" data-ecc-permissions="gm" name="data.obstacle.HitPoints" value="{{data.obstacle.HitPoints}}">
                <button class="submit button-icon" data-action="cancelBreakOrPassChoice" title="{{ localize 'CoC7.Cancel' }}"><i class="fas fa-undo"></i></button>
              </div>
              <div class="form-group small">
                <span class="icon bigger" title="{{ localize 'CoC7.ChooseWeapon' }}"><i class="game-icon game-icon-gooey-impact"></i></span>
                <select name="data.card.weaponChoice">
                  {{selectOptions card.weaponsOptions nameAttr="uuid" labelAttr="name" selected=data.card.weaponChoice}}
                </select>
              </div>
              {{#if customWeapon}}
                <div class="form-group small">
                  <div class="flex1"></div>
                  <div class="flex1 flexrow">
                    <span class="icon bigger" title="{{ localize 'CoC7.DamageInflicted' }}"><i class="game-icon game-icon-rolling-dices"></i></span>
                    <input type="text" data-ecc-permissions="gm" name="data.card.customWeaponDamage" value="{{data.card.customWeaponDamage}}">
                  </div>
                </div>
              {{/if}}
              {{#if card.validObstacleDamage}}
                <div class="card-buttons">
                  <button class="submit" data-action="askRollObstacleDamage">Ask damage roll</button>
                </div>
              {{/if}}
            {{/if}}
          {{/if}}
        {{else}}
          <div class="form-group small">
            <div class="flex">{{ localize 'CoC7.WaitForPlayerInput' }}</div>
            <button class="submit button-icon" data-action="cancelObstacleDefinition" title="{{ localize 'CoC7.Cancel' }}"><i class="fas fa-undo"></i></button>
          </div>
          <div class="card-buttons">
            <button class='submit' data-action='tryToNegotiateObstacle'>Attempt to negotiate that obstacle</button>
            <button class='submit' data-action='tryToBreakDownObstacle'>Attempt to break down !!</button>
          </div>
        {{/if}}
      {{else}}
      <div class="form-group ecc-radio">
        <div data-name="data.obstacle.barrier" class="toggle-switch ecc-switch">{{ localize 'CoC7.Barrier' }}</div>
        <div data-name="data.obstacle.hazard" class="toggle-switch ecc-switch">{{ localize 'CoC7.Hazard' }}</div>
      </div>
      {{#if data.obstacle.barrier}}
      <div class="form-group">
        <div data-name="data.obstacle.hasHitPoints" class="toggle-switch ecc-switch">Can be broken</div>
      </div>
      {{/if}}
      <div class="form-group">
        <label>Obstacle name:</label>
        <input type="text" data-ecc-permissions="gm" name="data.obstacle.name" value="{{data.obstacle.name}}"/>
      </div>
      <div class="card-buttons">
        <button class='submit' data-action='defineObstacle'>Validate</button>
      </div>
      {{/if}}

      <div class="status-list">
        <div class="status movement-action">
            <span>actions :</span>
            {{#each card.participant.movementActionArray as |actionClass|}}
            <i class="fas fa-bahai {{actionClass}}"></i>
            {{/each}}
        </div>
        {{#each status as |s|}}
        <div class="status {{s.css}}">{{s.name}}</div>
        {{/each}}
      </div>
    </div>
  </form>
</div>